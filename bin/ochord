#!/usr/bin/env ruby
# vim : ft=ruby : fileencoding=utf-8 :
require 'colored'
require 'json'

HELP = <<EOF
use `ochord [option] [arg1] [arg2]`
Here are the availible options
==============================
   - #{"create".red}        Create OpenChord network
   - #{"join".red}          Join OpenChord network
   - #{"insert".red}        Insert the given data (arg1, arg2 required)
   - #{"delete".red}        Delete the entry of the given key (arg1 required)
   - #{"retrieve".red}      Retrieve the entry of the given key (arg1 required)
EOF

class Launcher
  @@chordcmd = {
    :create   => "eclipse.Create",
    :join     => "eclipse.Join",
    :insert   => "eclipse.Insert",
    :delete   => "eclipse.Delete",
    :retrieve => "eclipse.Retrieve"
  }

  @@chordcmd.each do |k,str| 
    @@chordcmd[k] = "java -cp .:../build/classes:../config:../lib/log4j.jar #{str}" 
  end 

  def initialize(argv, filepath = nil)
    Signal.trap("INT") { |signo| puts "Signal <#{Signal.signame(signo)}> caught, finishing..." }
    parse_args(argv)

    return unless filepath 
    content = File.open(filepath, 'rb').read
    @nodelist = JSON.parse(content)
  end

  def parse_args(args)
    (print HELP; exit) if not ARGV[0] or not @javaargv = @@chordcmd[ARGV[0].to_sym]
    puts "Running OpenChord: #{@javaargv}"
  end

  def open()
    `ssh #{@nodelist['master']} #{@@chordcmd[:create]} &`  # Run master
    order @@chordcmd[:join] + " " + @nodelist['master']
    puts "--------------Network Created-----------------"
  end 

  def close()
    `ssh #{@nodelist['master']} #{@@chordcmd[:close]} &`  # Run master
    order(@@chordcmd[:close]).map(:join)
    puts "--------------Network Close-------------------"
  end 

  def order(command)
    threadpool = Array.new
    @nodelist['nodes'].each do |node|
      threadpool.push Thread.new { `ssh #{node} #{command} &` }
    end
    threadpool
  end

  def join(tp)
    tp.map(&:join)
  end

  def run()
    `#{@javaargv}`
  end
end

Launcher.new(ARGV, "/home/vicente/Eclipse/build/etc/eclipse.json").run
