#!/usr/bin/env ruby
# vim: ft=ruby : fileencoding=utf-8 : foldmethod=syntax : foldlevel=1 : foldnestmax=2
require 'colored'
require 'json'

class Launcher
  HELP = <<-EOF
use `ochord [option] [arg1] [arg2]`
Here are the available options
==============================
  #{[ ["create".red    , "Create OpenChord network"]                            ,
  ["join".red      , "Join OpenChord network"]                              ,
    ["insert".red    , "Insert the given data (arg1, arg2 required)"]         ,
    ["delete".red    , "Delete the entry of the given key (arg1 required)"]   ,
    ["retrieve".red  , "Retrieve the entry of the given key (arg1 required)"] ,
    ["info".green    , "Print out useful variables"]                          ,
    ["quiet".green   , "do not printout anything"]                            ,
    ["help".green    , "this"] ]
  .map { |item| "%20.20s  %-60.60s\n" % [item[0], item[1]] }.join }
EOF

  @@chordcmd = %w[create join insert delete retrieve].map do |str| 
    [str.to_sym, "java -cp .:../build/classes:../config:../lib/log4j.jar eclipse.#{str.capitalize}"]
  end.to_h

  def initialize (argv, filepath)
    Signal.trap("INT") { |signo| puts "Signal <#{Signal.signame(signo)}> caught, finishing..." }
    @pidlist = {}
    begin
      f = File.open(filepath, 'rb')
      @nodelist = JSON.parse(f.read)
    rescue
      $stderr.puts "File not found, change filepath".red
      print HELP
      exit
    end

    f.close
    (print HELP; exit) unless argv.any? and send argv[0]
  end

  def order (command)
    threadpool = Array.new
    @nodelist['nodes'].each do |node|
      threadpool.push Thread.new { `ssh #{node} #{command} &`; @pidlist[node] = $?.pid }
    end
    threadpool
  end

  def join (tp)
    tp.map(&:join)
  end

  def info
    require 'awesome_print'
    ap @nodelist 
  end

  def close
    `ssh #{@nodelist['master_address']} #{@@chordcmd[:close]} &`  # Run master
    order(@@chordcmd[:close]).map(:join)
    puts "--------------Network Close-------------------"
  end

  def create
    `ssh #{@nodelist['master_address']} #{@@chordcmd[:create]} &`  # Run master
    order @@chordcmd[:join] + " " + @nodelist['master_address']
    puts "--------------Network Created-----------------"
  end
end

raise 'ECLIPSE_PATH env variable is not defined' unless ENV["ECLIPSE_PATH"]
Launcher.new(ARGV, ENV["ECLIPSE_PATH"] + "/etc/eclipse.json")
